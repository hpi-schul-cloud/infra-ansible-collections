---
- name: Check for certificates fullchain
  stat:
    path: "{{ scalelite_letsencrypt_folder }}/live/{{ scalelite_basedomain }}/fullchain.pem"
  register: fullchain

- name: Check for certificates privkey
  stat:
    path: "{{ scalelite_letsencrypt_folder }}/live/{{ scalelite_basedomain }}/privkey.pem"
  register: privkey

# TODO: Ggf. auch noch andere pr√ºfen ?

- name: Create Letsencrypt certificates
  import_tasks:
    file: initial-certificates.yml
  when: not fullchain.stat.exists or not privkey.stat.exists

- name: Ensure the correct permissions
  file:
    state: directory
    recurse: true
    path: "{{ scalelite_letsencrypt_folder }}"
    owner: "{{ scalelite_certbot_user_id }}"
    group: "{{ scalelite_certbot_group_id }}"
    mode: "u=rwX,g=rX,o="

- name: Extra Greenlight instances certificates
  include_tasks:
    file: extra-greenlight-certificates.yml
  loop: "{{ scalelite_greenlight_extra_instances }}"
  loop_control:
    loop_var: instance
    label: "{{ instance.name }}"
