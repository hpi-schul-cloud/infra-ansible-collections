---
  - name: Install fail2ban
    apt:
      name: ['fail2ban']
      state: latest
  
  # following tasks(3) will throw errors when tested with molecule (service restart and handler cmd not compatible with container)
  # used the molecule-notest tag to skip this in molecule
  - name: Enable fail2ban
    service:
      name: fail2ban
      enabled: true
      state: started
    tags: molecule-notest

  - name: Set ignoreip for fail2ban 
    lineinfile:
      path: /etc/fail2ban/jail.conf
      regexp: "^ignoreip"
      line: "ignoreip = 127.0.0.1/8"
    notify: Restart fail2ban
    tags: molecule-notest

  - name: Copy ssh-jail for fail2ban
    copy:
      src: sshd.local
      dest: /etc/fail2ban/jail.d/sshd.local
      owner: root
      group: root
      mode: 0744
    notify: Restart fail2ban
    tags: molecule-notest